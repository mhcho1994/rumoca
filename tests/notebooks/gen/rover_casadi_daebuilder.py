
# --------------------------------------------
# Automatically generated by Rumoca
# --------------------------------------------
import casadi as ca
import numpy as np
sin = ca.sin; cos = ca.cos; tan = ca.tan

class Model:
    """
    Flattened Modelica Model
    """
    def __init__(self, model_name):
        # Create new dae
        dae = ca.DaeBuilder(model_name)

        # Time & dt (used in if-when clock)
        time = dae.add('time', 'independent')
        dt = 0.01

        # -----------------------------
        # Declare variables
        # -----------------------------
        
        # ============================================
        # Declare u

        
        
        str = dae.add('str', 'input', dict(start = 0.0))
        
        thr = dae.add('thr', 'input', dict(start = 0.0))
        
        

        
        # ============================================
        # Declare p

        
        
        h = dae.add('h', 'parameter', 'tunable', dict(start = 0.1))
        
        ixx = dae.add('ixx', 'parameter', 'tunable', dict(start = 1.0))
        
        iyy = dae.add('iyy', 'parameter', 'tunable', dict(start = 1.0))
        
        izz = dae.add('izz', 'parameter', 'tunable', dict(start = 1.0))
        
        l = dae.add('l', 'parameter', 'tunable', dict(start = 0.7))
        
        m = dae.add('m', 'parameter', 'tunable', dict(start = 1.0))
        
        m1_tau = dae.add('m1_tau', 'parameter', 'tunable', dict(start = 1.0))
        
        mag_decl = dae.add('mag_decl', 'parameter', 'tunable', dict(start = 0.0))
        
        r = dae.add('r', 'parameter', 'tunable', dict(start = 0.1))
        
        theta0 = dae.add('theta0', 'parameter', 'tunable', dict(start = 0.0))
        
        w = dae.add('w', 'parameter', 'tunable', dict(start = 0.3))
        
        wheel_base = dae.add('wheel_base', 'parameter', 'tunable', dict(start = 0.5))
        
        wheel_front_pos_x = dae.add('wheel_front_pos_x', 'parameter', 'tunable', dict(start = 0.25))
        
        wheel_ixx = dae.add('wheel_ixx', 'parameter', 'tunable', dict(start = 0.1))
        
        wheel_iyy = dae.add('wheel_iyy', 'parameter', 'tunable', dict(start = 0.1))
        
        wheel_izz = dae.add('wheel_izz', 'parameter', 'tunable', dict(start = 0.1))
        
        wheel_left_pos_y = dae.add('wheel_left_pos_y', 'parameter', 'tunable', dict(start = 0.175))
        
        wheel_m = dae.add('wheel_m', 'parameter', 'tunable', dict(start = 0.1))
        
        wheel_max_turn_angle = dae.add('wheel_max_turn_angle', 'parameter', 'tunable', dict(start = 0.7854))
        
        wheel_pos_z = dae.add('wheel_pos_z', 'parameter', 'tunable', dict(start = 0.05))
        
        wheel_radius = dae.add('wheel_radius', 'parameter', 'tunable', dict(start = 0.1))
        
        wheel_rear_pos_x = dae.add('wheel_rear_pos_x', 'parameter', 'tunable', dict(start = 0.25))
        
        wheel_right_pos_y = dae.add('wheel_right_pos_y', 'parameter', 'tunable', dict(start = 0.175))
        
        wheel_separation = dae.add('wheel_separation', 'parameter', 'tunable', dict(start = 0.5))
        
        wheel_width = dae.add('wheel_width', 'parameter', 'tunable', dict(start = 0.05))
        
        x0 = dae.add('x0', 'parameter', 'tunable', dict(start = 0.0))
        
        y0 = dae.add('y0', 'parameter', 'tunable', dict(start = 0.0))
        
        z0 = dae.add('z0', 'parameter', 'tunable', dict(start = 0.25))
        
        

        
        # ============================================
        # Declare c

        

        
        # ============================================
        # Declare cp

        
        
        

        
        # ============================================
        # Declare x

        
        
        m1_omega = dae.add('m1_omega', dict(start = 0.0))
        
        theta = dae.add('theta', dict(start = 0.0))
        
        x = dae.add('x', dict(start = 0.0))
        
        y = dae.add('y', dict(start = 0.0))
        
        z = dae.add('z', dict(start = 0.0))
        
        

        
        # ============================================
        # Declare m

        
        
        

        
        # ============================================
        # Declare y

        
        
        m1_omega_ref = dae.add('m1_omega_ref', dict(start = 0.0))
        
        v = dae.add('v', dict(start = 0.0))
        
        

        
        # ============================================
        # Declare z

        
        
        

        



        
        # ============================================
        # Declare pre_x

        
        pre_m1_omega = dae.pre(m1_omega)
        
        pre_theta = dae.pre(theta)
        
        pre_x = dae.pre(x)
        
        pre_y = dae.pre(y)
        
        pre_z = dae.pre(z)
        

        
        # ============================================
        # Declare pre_m

        

        
        # ============================================
        # Declare pre_z

        

        



        # -----------------------------
        # Derivative declarations
        # ============================================
        # Declare x_dot

        
        der_m1_omega = dae.der(m1_omega)
        
        der_theta = dae.der(theta)
        
        der_x = dae.der(x)
        
        der_y = dae.der(y)
        
        der_z = dae.der(z)
        





        # Helpers for if/when
        def if_else_builder(s, builder, terminal_state):
            st = terminal_state
            for cond, val in reversed(builder):
                st = ca.if_else(s == int(cond[1:]), val, st)
            return st
        def if_else_builder2(builder, terminal_state):
            st = terminal_state
            for cond, val in reversed(builder):
                st = ca.if_else(cond, val, st)
            return st

        # -----------------------------
        # Equations (fx)
        # -----------------------------
        dae.eq(v, (r*m1_omega))
        dae.eq(der_x, (v*cos(theta)))
        dae.eq(der_y, (v*sin(theta)))
        dae.eq(der_z, 0.0)
        dae.eq(der_theta, ((v/wheel_base)*tan(str)))
        dae.eq(m1_omega_ref, thr)
        dae.eq(der_m1_omega, ((1.0/m1_tau)*(m1_omega_ref-m1_omega)))
        

        dae.sort('w')
        self.dae = dae

    def display(self):
        self.dae.disp(True)

    def simulate(self, t0, tf, dt, x0=None, p0=None, f_u=None, max_events=100):
        if p0 is None:
            p0 = self.dae.start(self.dae.p())
        if x0 is None:
            x0 = self.dae.start(self.dae.x())
        tgrid = np.arange(t0, tf, dt)
        simopts = dict(transition=self.dae.transition(), verbose=False,
                       event_tol=1e-12, max_events=100000, max_event_iter=2000)
        sim = ca.integrator('sim', 'cvodes', self.dae.create(), 0, tgrid, simopts)
        simres = sim(x0=x0, p=p0) if f_u is None else sim(x0=x0, p=p0, u=f_u)
        return tgrid, simres
