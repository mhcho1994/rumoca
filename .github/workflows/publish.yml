name: Publish

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

env:
  RUST_VERSION: "nightly-2025-04-13"

permissions:
  contents: write
  actions: read
  id-token: write

jobs:
  publish:
    name: Publish Release
    # Only run if CI succeeded AND this is a tag (v*)
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/rumoca
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Get tag name
        id: tag
        run: echo "name=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT

      # Download all artifacts from CI workflow using gh CLI
      - name: Download artifacts from CI
        run: |
          mkdir -p rust-binaries python-dist vscode-ext

          RUN_ID=${{ github.event.workflow_run.id }}
          echo "Downloading artifacts from CI run $RUN_ID..."

          # List available artifacts first
          echo "Available artifacts:"
          gh run view $RUN_ID --json artifacts --jq '.artifacts[].name'

          # Download all artifacts
          gh run download $RUN_ID --dir artifacts

          echo "=== Downloaded structure ==="
          find artifacts -type f | head -50

          # Move Rust binaries
          for dir in artifacts/rumoca-*; do
            if [ -d "$dir" ]; then
              echo "Processing Rust artifact: $dir"
              find "$dir" -type f -exec cp {} rust-binaries/ \;
            fi
          done

          # Move Python wheels
          for dir in artifacts/wheels-*; do
            if [ -d "$dir" ]; then
              echo "Processing Python artifact: $dir"
              find "$dir" -type f \( -name "*.whl" -o -name "*.tar.gz" \) -exec cp {} python-dist/ \;
            fi
          done

          # Move VS Code extension
          if [ -d "artifacts/vscode-extension" ]; then
            echo "Processing VS Code artifact"
            find "artifacts/vscode-extension" -type f -name "*.vsix" -exec cp {} vscode-ext/ \;
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List downloaded artifacts
        run: |
          echo "=== Rust binaries ==="
          ls -la rust-binaries/ || echo "No rust binaries"
          echo "=== Python wheels ==="
          ls -la python-dist/ || echo "No python wheels"
          echo "=== VS Code extension ==="
          ls -la vscode-ext/ || echo "No vscode extension"

      # Create GitHub Release
      - name: Create GitHub Release
        run: |
          gh release create ${{ steps.tag.outputs.name }} \
            --title "Release ${{ steps.tag.outputs.name }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload Rust binaries to release
      - name: Upload Rust binaries to release
        run: |
          cd rust-binaries
          for file in *; do
            if [ -f "$file" ]; then
              echo "Uploading $file"
              gh release upload ${{ steps.tag.outputs.name }} "$file" --clobber
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload Python wheels to release
      - name: Upload Python wheels to release
        run: |
          cd python-dist
          for file in *.whl *.tar.gz; do
            if [ -f "$file" ]; then
              echo "Uploading $file"
              gh release upload ${{ steps.tag.outputs.name }} "$file" --clobber
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload VS Code extension to release
      - name: Upload VS Code extension to release
        run: |
          cd vscode-ext
          for file in *.vsix; do
            if [ -f "$file" ]; then
              echo "Uploading $file"
              gh release upload ${{ steps.tag.outputs.name }} "$file" --clobber
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Publish to crates.io
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain ${{ env.RUST_VERSION }}
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true

      # Publish to PyPI
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Publish to PyPI
        run: |
          pip install twine
          twine upload python-dist/*.whl python-dist/*.tar.gz --skip-existing
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

      # Publish VS Code extension
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Publish to VS Code Marketplace
        run: |
          cd vscode-ext
          npx @vscode/vsce publish --packagePath *.vsix
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX Registry
        run: |
          cd vscode-ext
          npx ovsx publish *.vsix -p ${{ secrets.OVSX_TOKEN }}
        continue-on-error: true
